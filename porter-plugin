#!/bin/bash
# porter-plugin - Simple plugin manager with version syntax: plugin:version

set -e

REPO="git+ssh://git@github.com/shashankatporter/custom-devbox-plugin.git"

usage() {
    echo "Porter Plugin Manager"
    echo "Usage: $0 <add|remove|list> [plugin:version]"
    echo ""
    echo "Examples:"
    echo "  $0 add org-linter:v1.2.0     # Specific version"
    echo "  $0 add org-linter            # Latest version"
    echo "  $0 add db-seeder:v2.0.0      # Specific version"
    echo "  $0 remove org-linter         # Remove plugin"
    echo "  $0 list                      # Show available plugins"
    echo ""
    echo "Available versions:"
    echo "  org-linter: v1.0.0, v1.1.0, v1.2.0, latest"
    echo "  db-seeder: v1.0.0, v2.0.0, v2.1.0, latest"
}

parse_plugin() {
    local input="$1"
    
    if [[ "$input" == *":"* ]]; then
        plugin_name="${input%:*}"
        version="${input#*:}"
    else
        plugin_name="$input"
        version="latest"
    fi
}

add_plugin() {
    local input="$1"
    parse_plugin "$input"
    
    local package_name="$plugin_name"
    if [ "$version" != "latest" ]; then
        package_name="$plugin_name-$version"
    fi
    
    echo "Adding $plugin_name version $version..."
    
    if devbox add "$REPO#$package_name"; then
        echo "‚úÖ Successfully added $plugin_name:$version"
    else
        echo "‚ùå Failed to add $plugin_name:$version"
        echo "Available versions: $0 list"
        exit 1
    fi
}

remove_plugin() {
    local input="$1"
    parse_plugin "$input"
    
    echo "Removing $plugin_name..."
    
    # Try different possible package names
    for pkg in "$plugin_name" "$plugin_name-$version" "$plugin_name-latest"; do
        if devbox remove "$REPO#$pkg" 2>/dev/null; then
            echo "‚úÖ Removed $plugin_name"
            return
        fi
    done
    
    echo "‚ùå Could not remove $plugin_name (maybe not installed?)"
}

list_plugins() {
    echo "Available Porter Plugins:"
    echo ""
    echo "üîç org-linter - Organization code linter"
    echo "   Versions: v1.0.0, v1.1.0, v1.2.0, latest"
    echo ""
    echo "üå± db-seeder - Database seeding tool"
    echo "   Versions: v1.0.0, v2.0.0, v2.1.0, latest"
    echo ""
    echo "Usage: $0 add org-linter:v1.2.0"
}

check_devbox() {
    if ! command -v devbox &> /dev/null; then
        echo "‚ùå devbox not found"
        exit 1
    fi
    
    if [ ! -f "devbox.json" ]; then
        echo "‚ùå No devbox.json found. Run 'devbox init' first."
        exit 1
    fi
}

case "${1:-}" in
    "add")
        if [ -z "${2:-}" ]; then
            echo "‚ùå Specify plugin name"
            usage
            exit 1
        fi
        check_devbox
        add_plugin "$2"
        ;;
    "remove")
        if [ -z "${2:-}" ]; then
            echo "‚ùå Specify plugin name"
            usage
            exit 1
        fi
        check_devbox
        remove_plugin "$2"
        ;;
    "list")
        list_plugins
        ;;
    *)
        usage
        ;;
esac
